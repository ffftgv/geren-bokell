name: Sync Public Gitee Repository (Debug Mode)

on:
  workflow_dispatch:
  schedule:
    - cron: '*/20 * * * *' # æ¯20åˆ†é’ŸåŒæ­¥ä¸€æ¬¡

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: 1ï¸âƒ£ æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        run: |
          echo "ğŸ” å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“¦ GitHub ä»“åº“: ${{ github.repository }}"
          echo "ğŸ‘¤ ä»“åº“æ‰€æœ‰è€…: ${{ github.repository_owner }}"
          echo "ğŸ”– ä»“åº“åç§°: ${{ github.event.repository.name || github.event.repository.slug }}"
          echo "ğŸ”„ äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
          echo "ğŸ–¥ï¸ è¿è¡Œå™¨ä¿¡æ¯: $RUNNER_OS, $RUNNER_ARCH"

      - åå­—: 2ï¸âƒ£ æ£€æŸ¥ Gitee ä»“åº“å¯è®¿é—®æ€§
        run: |
          echo "ğŸ“¡ æµ‹è¯• Gitee ä»“åº“è¿é€šæ€§..."
          curl -I https://gitee.com/wzjwwcom/personal-blog.git
          echo "âœ… Gitee ä»“åº“å¯è®¿é—®"

      - åå­—: 3ï¸âƒ£ å…‹éš† Gitee ä»“åº“
        run: |
          echo "ğŸ“¥ å¼€å§‹å…‹éš† Gitee ä»“åº“..."
          git clone https://gitee.com/wzjwwcom/personal-blog.git repo
          cd repo
          echo "ğŸ“‚ å…‹éš†æˆåŠŸ! ä»“åº“å†…å®¹:"
          ls -la
          echo "ğŸ†” ä»“åº“ HEAD æäº¤:"
          git log -1

      - åå­—: 4ï¸âƒ£ é…ç½®å¹¶æ¨é€è‡³ GitHub
        run: |
          cd repo
          
          # é…ç½® Git ä¿¡æ¯
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          # æ„å»º GitHub ä»“åº“ URL (å¤šç§æ–¹å¼å°è¯•)
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name || github.event.repository.slug || github.repository }}"

          # å¦‚æœ REPO_NAME ä»ç„¶åŒ…å«æ–œæ ï¼Œåˆ™åˆ†å‰²
          if [[ "$REPO_NAME" == *"/"* ]]; then
            REPO_OWNER="${REPO_NAME%%/*}"
            REPO_NAME="${REPO_NAME#*/}"
          fi
          
          echo "ğŸ“¤ æ„å»º GitHub ä»“åº“ URL..."
          GITHUB_URL="https://x-access-token:${{ github.token }}@github.com/$REPO_OWNER/$REPO_NAME.git"
          echo "ğŸ”— ä½¿ç”¨ URL: $GITHUB_URL"
          
          # æµ‹è¯• URL è¿é€šæ€§
          curl -I "$GITHUB_URL" || echo "âš ï¸ æ³¨æ„: curl æµ‹è¯•å¯èƒ½å¤±è´¥ï¼Œå› ä¸ºéœ€è¦è®¤è¯"
          
          # æ·»åŠ è¿œç¨‹ä»“åº“
          git remote add github "$GITHUB_URL" || git remote set-url github "$GITHUB_URL"
          
          echo "ğŸ”„ è·å–è¿œç¨‹ä¿¡æ¯..."
          git remote -v
          
          echo "ğŸ“¤ æ¨é€æ‰€æœ‰åˆ†æ”¯..."
          git push -u github --all --force || {
            echo "âŒ æ¨é€å¤±è´¥! å°è¯•è¯¦ç»†é”™è¯¯è¯Šæ–­:"
            git ls-remote --heads "$GITHUB_URL" || echo "æ— æ³•åˆ—å‡ºè¿œç¨‹åˆ†æ”¯"
            exit 1
          }
          
          echo "ğŸ·ï¸ æ¨é€æ‰€æœ‰æ ‡ç­¾..."
          git push -u github --tags --force
